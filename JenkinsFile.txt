pipeline {
   agent any
     environment {
        IMAGE_TAG = "${BUILD_NUMBER}"
		HOME = "${env.WORKSPACE}"
    }
    stages {
        stage('Checkout') {
	    agent {
	    docker { image 'python' }
    	    }
            steps {
                // Get some code from a GitHub repository
                // git 'https://github.com/rocky19devops/JenkinsPipline.git'
		git branch: 'main', url: 'https://github.com/rocky19devops/JenkinsPipline.git'
                }
            }
        stage('Build') {
	    agent any
            steps {
	        sh '''
		echo 'Building Docker Image............'
                docker build -t rocky19devops/rockyapps${BUILD_NUMBER} .
		'''
                }
            }
        stage('Push') {
	    agent any
            steps {
		withCredentials([usernamePassword(credentialsId: 'rockydockerhub', passwordVariable: 'dockerHubPassword', usernameVariable: 'dockerHubUser')]) {
		  sh "docker login -u ${env.dockerHubUser} -p ${env.dockerHubPassword}"
	          echo 'Pushing Docker Image............'
                  sh "docker push rocky19devops/rockyapps${BUILD_NUMBER}"
		}
            }
        
        }
	stage('Running Docker') {
	    agent any
            steps {
		withCredentials([usernamePassword(credentialsId: 'rockydockerhub', passwordVariable: 'dockerHubPassword', usernameVariable: 'dockerHubUser')]) {
		  sh "docker login -u ${env.dockerHubUser} -p ${env.dockerHubPassword}"
	          echo 'Running Docker Container ............'
		  sh "docker pull rocky19devops/rockyapps18"
                  sh "docker run -p 8090:8080" rocky19devops/rockyapps18"
		}
            }
        
        }
    }
}
